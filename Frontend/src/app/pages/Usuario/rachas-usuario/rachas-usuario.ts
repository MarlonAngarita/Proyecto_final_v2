// ===================================================================================================
// IMPORTACIONES Y DEPENDENCIAS
// ===================================================================================================

import { Component, OnInit, OnDestroy } from '@angular/core';
import { CommonModule } from '@angular/common';
import { Router } from '@angular/router';
import { UserService } from '../../../services/user.service';
import { MedallasService } from '../../../services/medallas.service';
import { Subscription } from 'rxjs';

// ===================================================================================================
// INTERFACES DE TIPOS DE DATOS
// ===================================================================================================

/**
 * Interface que define la estructura de un objetivo de racha
 * Representa una meta que el usuario puede alcanzar manteniendo su racha
 */
interface Objetivo {
  dias: number; // N√∫mero de d√≠as requeridos para completar el objetivo
  descripcion: string; // Descripci√≥n detallada del objetivo
  icono: string; // Emoji o icono que representa el objetivo
  titulo: string; // T√≠tulo descriptivo del objetivo
  recompensa: string; // Descripci√≥n de la recompensa al completar el objetivo
  completado: boolean; // Estado de completado del objetivo
  progreso: number; // Porcentaje de progreso hacia el objetivo (0-100)
}

/**
 * Interface que define las estad√≠sticas completas de racha del usuario
 * Contiene toda la informaci√≥n sobre el estado actual y hist√≥rico de las rachas
 */
interface EstadisticaRacha {
  rachaActual: number; // D√≠as consecutivos actuales de la racha
  rachaMaxima: number; // M√°ximo n√∫mero de d√≠as consecutivos alcanzados
  totalDias: number; // Total de d√≠as activos acumulados
  fechaUltimaActividad: Date | null; // Fecha de la √∫ltima actividad registrada
  proteccionesDisponibles: number; // N√∫mero de protecciones disponibles para usar
  proteccionesUsadas: number; // N√∫mero de protecciones ya utilizadas
  recuperacionesUsadas: number; // N√∫mero de recuperaciones ya utilizadas
}

// ===================================================================================================
// COMPONENTE PRINCIPAL DE RACHAS
// ===================================================================================================

/**
 * Componente RachasUsuario
 *
 * Gestiona el sistema completo de rachas del usuario, incluyendo:
 * - Tracking de actividad diaria y rachas consecutivas
 * - Sistema de objetivos gamificados con recompensas
 * - Mec√°nicas de protecci√≥n y recuperaci√≥n de rachas
 * - Integraci√≥n con sistema de medallas
 * - Persistencia de datos en localStorage
 * - Interfaz visual moderna y responsive
 *
 * @author Sistema K√ºtsa
 * @version 2.0 - Sistema gamificado avanzado
 */
@Component({
  selector: 'app-rachas-usuario',
  standalone: true,
  imports: [CommonModule],
  templateUrl: './rachas-usuario.html',
  styleUrl: './rachas-usuario.css',
})
export class RachasUsuario implements OnInit, OnDestroy {
  // ===================================================================================================
  // PROPIEDADES DE ESTADO DE CARGA
  // ===================================================================================================

  /** Indica si el componente est√° cargando datos */
  cargando = false;

  /** Mensaje de error si ocurre alg√∫n problema durante la carga */
  errorCarga = '';

  // ===================================================================================================
  // DATOS PRINCIPALES DEL SISTEMA DE RACHAS
  // ===================================================================================================

  /**
   * Estad√≠sticas completas de la racha del usuario
   * Se inicializa con valores por defecto y se actualiza con datos reales
   */
  estadisticas: EstadisticaRacha = {
    rachaActual: 0,
    rachaMaxima: 0,
    totalDias: 0,
    fechaUltimaActividad: null,
    proteccionesDisponibles: 3, // Valor inicial por defecto
    proteccionesUsadas: 0,
    recuperacionesUsadas: 0,
  };

  // ===================================================================================================
  // CONFIGURACI√ìN DE OBJETIVOS GAMIFICADOS
  // ===================================================================================================

  /**
   * Array de objetivos de racha definidos en el sistema
   * Cada objetivo representa una meta progresiva que motiva al usuario
   * a mantener su racha por per√≠odos espec√≠ficos de tiempo
   */
  objetivos: Objetivo[] = [
    {
      dias: 3,
      titulo: 'Primer Impulso',
      descripcion: '¬°Mant√©n la racha por 3 d√≠as consecutivos!',
      icono: 'üå±', // Icono que representa crecimiento inicial
      recompensa: '+50 puntos', // Recompensa b√°sica para motivar inicio
      completado: false,
      progreso: 0,
    },
    {
      dias: 7,
      titulo: 'Una Semana Fuerte',
      descripcion: '¬°Una semana completa de actividad continua!',
      icono: 'üî•', // Icono de fuego para representar constancia
      recompensa: '+100 puntos + Protecci√≥n', // Incluye power-up de protecci√≥n
      completado: false,
      progreso: 0,
    },
    {
      dias: 14,
      titulo: 'Dos Semanas Imparable',
      descripcion: '¬°Dos semanas seguidas aprendiendo!',
      icono: 'üí™', // Icono de fuerza para representar resistencia
      recompensa: '+200 puntos + Medalla', // Incluye reconocimiento con medalla
      completado: false,
      progreso: 0,
    },
    {
      dias: 30,
      titulo: 'Mes Legendario',
      descripcion: '¬°Un mes completo de racha incre√≠ble!',
      icono: 'üèÜ', // Trofeo para logro significativo
      recompensa: '+500 puntos + Recuperaci√≥n', // Incluye power-up de recuperaci√≥n
      completado: false,
      progreso: 0,
    },
    {
      dias: 60,
      titulo: 'Maestro de la Constancia',
      descripcion: '¬°Dos meses sin fallar ni un d√≠a!',
      icono: 'üåü', // Estrella para nivel de maestr√≠a
      recompensa: '+1000 puntos + T√≠tulo', // Recompensa premium con t√≠tulo
      completado: false,
      progreso: 0,
    },
    {
      dias: 100,
      titulo: 'Leyenda Centenaria',
      descripcion: '¬°100 d√≠as de constancia absoluta!',
      icono: 'üíé', // Diamante para el logro m√°s alto
      recompensa: '+2000 puntos + Medalla Especial', // M√°xima recompensa
      completado: false,
      progreso: 0,
    },
  ];

  // ===================================================================================================
  // ESTADOS DE INTERFAZ Y MODALES
  // ===================================================================================================

  /** Control de visibilidad del modal de estad√≠sticas detalladas */
  modalRachaActivo = false;

  /** Control de visibilidad del modal de confirmaci√≥n de protecci√≥n */
  modalProteccionActivo = false;

  /** Control de visibilidad del modal de confirmaci√≥n de recuperaci√≥n */
  modalRecuperacionActivo = false;

  /** Control de visibilidad del modal de mensajes de confirmaci√≥n */
  modalConfirmacionActivo = false;

  /** Mensaje que se muestra en el modal de confirmaci√≥n */
  mensajeConfirmacion = '';

  // ===================================================================================================
  // ESTADOS DE MEC√ÅNICAS DE PROTECCI√ìN Y RECUPERACI√ìN
  // ===================================================================================================

  /** Indica si el usuario puede usar una protecci√≥n de racha actualmente */
  puedeUsarProteccion = false;

  /** Indica si el usuario puede usar una recuperaci√≥n de racha actualmente */
  puedeUsarRecuperacion = false;

  /** Indica si la racha actual est√° en peligro de perderse */
  rachaEnPeligro = false;

  // ===================================================================================================
  // GESTI√ìN DE SUBSCRIPCIONES REACTIVE
  // ===================================================================================================

  /** Subscription para manejar observables y evitar memory leaks */
  private subscription: Subscription = new Subscription();

  // ===================================================================================================
  // CONSTRUCTOR E INYECCI√ìN DE DEPENDENCIAS
  // ===================================================================================================

  /**
   * Constructor del componente
   * Inyecta los servicios necesarios para el funcionamiento del sistema de rachas
   *
   * @param userService - Servicio para gesti√≥n de datos del usuario
   * @param medallasService - Servicio para gesti√≥n del sistema de medallas
   * @param router - Router de Angular para navegaci√≥n
   */
  constructor(
    private userService: UserService,
    private medallasService: MedallasService,
    private router: Router,
  ) {}

  // ===================================================================================================
  // M√âTODOS DEL CICLO DE VIDA DEL COMPONENTE
  // ===================================================================================================

  /**
   * M√©todo de inicializaci√≥n del componente
   * Se ejecuta autom√°ticamente cuando el componente se carga
   * Inicia todos los procesos necesarios para el sistema de rachas
   */
  ngOnInit(): void {
    console.log('üî• Iniciando sistema de rachas...');
    this.cargarDatosRacha(); // Carga datos desde localStorage y userService
    this.verificarEstadoRacha(); // Analiza el estado actual de la racha
    this.actualizarObjetivos(); // Actualiza progreso de objetivos
  }

  /**
   * M√©todo de limpieza del componente
   * Se ejecuta autom√°ticamente cuando el componente se destruye
   * Limpia las subscripciones para evitar memory leaks
   */
  ngOnDestroy(): void {
    this.subscription.unsubscribe();
  }

  // ===================================================================================================
  // M√âTODOS DE CARGA Y GESTI√ìN DE DATOS
  // ===================================================================================================

  /**
   * Carga los datos de racha desde m√∫ltiples fuentes
   * Combina datos del userService con datos persistidos en localStorage
   * Maneja estados de carga y errores de forma robusta
   */
  cargarDatosRacha(): void {
    this.cargando = true;
    this.errorCarga = '';

    try {
      // Obtener datos del usuario actual desde el servicio
      const user = this.userService.getUsuarioActual();

      // Obtener datos adicionales de racha desde localStorage
      const datosRacha = this.obtenerDatosRachaLocalStorage();

      // Combinar datos de ambas fuentes en el objeto de estad√≠sticas
      this.estadisticas = {
        rachaActual: user.rachaDias || 0, // Racha actual del usuario
        rachaMaxima: datosRacha.rachaMaxima || user.rachaDias || 0, // M√°xima racha alcanzada
        totalDias: datosRacha.totalDias || user.rachaDias || 0, // Total de d√≠as activos
        fechaUltimaActividad: datosRacha.fechaUltimaActividad // √öltima fecha de actividad
          ? new Date(datosRacha.fechaUltimaActividad)
          : null,
        proteccionesDisponibles: datosRacha.proteccionesDisponibles || 3, // Protecciones disponibles
        proteccionesUsadas: datosRacha.proteccionesUsadas || 0, // Protecciones ya usadas
        recuperacionesUsadas: datosRacha.recuperacionesUsadas || 0, // Recuperaciones ya usadas
      };

      // Actualizar racha m√°xima si la actual es mayor (nuevo r√©cord)
      if (this.estadisticas.rachaActual > this.estadisticas.rachaMaxima) {
        this.estadisticas.rachaMaxima = this.estadisticas.rachaActual;
        this.guardarDatosRacha(); // Persistir el nuevo r√©cord
      }

      this.cargando = false;
      console.log('‚úÖ Datos de racha cargados:', this.estadisticas);
    } catch (error) {
      console.error('‚ùå Error al cargar datos de racha:', error);
      this.errorCarga = 'Error al cargar los datos de racha';
      this.cargando = false;
    }
  }

  /**
   * Obtiene datos de racha persistidos en localStorage
   * Incluye verificaci√≥n de compatibilidad con SSR (Server-Side Rendering)
   *
   * @returns Objeto con datos de racha o objeto vac√≠o si no hay datos
   */
  private obtenerDatosRachaLocalStorage(): any {
    try {
      // Verificar disponibilidad de localStorage (no disponible en SSR)
      if (typeof localStorage !== 'undefined') {
        return JSON.parse(localStorage.getItem('datosRacha') || '{}');
      }
      return {};
    } catch (error) {
      return {};
    }
  }

  private guardarDatosRacha(): void {
    if (typeof localStorage !== 'undefined') {
      const datosRacha = {
        rachaMaxima: this.estadisticas.rachaMaxima,
        totalDias: this.estadisticas.totalDias,
        fechaUltimaActividad: this.estadisticas.fechaUltimaActividad?.toISOString(),
        proteccionesDisponibles: this.estadisticas.proteccionesDisponibles,
        proteccionesUsadas: this.estadisticas.proteccionesUsadas,
        recuperacionesUsadas: this.estadisticas.recuperacionesUsadas,
      };

      localStorage.setItem('datosRacha', JSON.stringify(datosRacha));
    }
  }

  private verificarEstadoRacha(): void {
    const ahora = new Date();
    const hoy = new Date(ahora.getFullYear(), ahora.getMonth(), ahora.getDate());

    if (this.estadisticas.fechaUltimaActividad) {
      const fechaUltima = new Date(this.estadisticas.fechaUltimaActividad);
      const fechaUltimaLocal = new Date(
        fechaUltima.getFullYear(),
        fechaUltima.getMonth(),
        fechaUltima.getDate(),
      );

      const diferenciaDias = Math.floor(
        (hoy.getTime() - fechaUltimaLocal.getTime()) / (1000 * 60 * 60 * 24),
      );

      if (diferenciaDias === 1) {
        this.rachaEnPeligro = true;
        this.puedeUsarProteccion = this.estadisticas.proteccionesDisponibles > 0;
      } else if (diferenciaDias > 1) {
        this.puedeUsarRecuperacion = this.estadisticas.rachaActual > 0;
      }
    }
  }

  private actualizarObjetivos(): void {
    this.objetivos = this.objetivos.map((objetivo) => {
      const completado = this.estadisticas.rachaActual >= objetivo.dias;
      const progreso = Math.min((this.estadisticas.rachaActual / objetivo.dias) * 100, 100);

      return {
        ...objetivo,
        completado,
        progreso,
      };
    });
  }

  usarProteccionRacha(): void {
    if (!this.puedeUsarProteccion || this.estadisticas.proteccionesDisponibles <= 0) {
      this.mostrarMensaje('No tienes protecciones disponibles');
      return;
    }

    this.modalProteccionActivo = true;
  }

  confirmarProteccion(): void {
    this.estadisticas.proteccionesDisponibles--;
    this.estadisticas.proteccionesUsadas++;
    this.estadisticas.fechaUltimaActividad = new Date();

    // Actualizar user service
    this.userService.actualizarConexion();

    this.guardarDatosRacha();
    this.verificarEstadoRacha();

    this.modalProteccionActivo = false;
    this.mostrarMensaje('¬°Protecci√≥n de racha activada! Tu racha est√° a salvo.');

    console.log('üõ°Ô∏è Protecci√≥n de racha usada');
  }

  usarRecuperacionRacha(): void {
    if (!this.puedeUsarRecuperacion) {
      this.mostrarMensaje('No puedes usar recuperaci√≥n en este momento');
      return;
    }

    this.modalRecuperacionActivo = true;
  }

  confirmarRecuperacion(): void {
    // Recuperar la mitad de la racha perdida (m√≠nimo 1 d√≠a)
    const rachaRecuperada = Math.max(1, Math.floor(this.estadisticas.rachaMaxima / 2));

    this.estadisticas.rachaActual = rachaRecuperada;
    this.estadisticas.recuperacionesUsadas++;
    this.estadisticas.fechaUltimaActividad = new Date();

    // Actualizar user service
    const user = this.userService.getUsuarioActual();
    user.rachaDias = rachaRecuperada;
    if (typeof localStorage !== 'undefined') {
      localStorage.setItem('usuario_actual', JSON.stringify(user));
    }

    this.guardarDatosRacha();
    this.verificarEstadoRacha();
    this.actualizarObjetivos();

    this.modalRecuperacionActivo = false;
    this.mostrarMensaje(`¬°Racha recuperada! Vuelves a tener ${rachaRecuperada} d√≠as.`);

    console.log('üí™ Recuperaci√≥n de racha usada');
  }

  marcarActividadHoy(): void {
    const user = this.userService.getUsuarioActual();
    const nuevaRacha = this.estadisticas.rachaActual + 1;

    user.rachaDias = nuevaRacha;
    if (typeof localStorage !== 'undefined') {
      localStorage.setItem('usuario_actual', JSON.stringify(user));
    }

    this.estadisticas.rachaActual = nuevaRacha;
    this.estadisticas.totalDias++;
    this.estadisticas.fechaUltimaActividad = new Date();

    if (nuevaRacha > this.estadisticas.rachaMaxima) {
      this.estadisticas.rachaMaxima = nuevaRacha;
    }

    this.guardarDatosRacha();
    this.actualizarObjetivos();
    this.verificarNuevasMedallas();

    this.mostrarMensaje('¬°Actividad registrada! Tu racha contin√∫a.');

    console.log('‚úÖ Actividad del d√≠a registrada');
  }

  private verificarNuevasMedallas(): void {
    // Verificar si se desbloquearon nuevas medallas de racha
    const nuevasMedallas = this.medallasService.verificarNuevasMedallas();

    if (nuevasMedallas.length > 0) {
      const medallasRacha = nuevasMedallas.filter((m) => m.categoria === 'Racha');
      if (medallasRacha.length > 0) {
        this.mostrarMensaje(
          `¬°Felicidades! Has obtenido ${medallasRacha.length} nueva(s) medalla(s) de racha!`,
        );
      }
    }
  }

  verDetalleRacha(): void {
    this.modalRachaActivo = true;
  }

  private mostrarMensaje(mensaje: string): void {
    this.mensajeConfirmacion = mensaje;
    this.modalConfirmacionActivo = true;

    setTimeout(() => {
      this.modalConfirmacionActivo = false;
      this.mensajeConfirmacion = '';
    }, 3000);
  }

  // M√©todos para cerrar modales
  cerrarModalRacha(): void {
    this.modalRachaActivo = false;
  }

  cerrarModalProteccion(): void {
    this.modalProteccionActivo = false;
  }

  cerrarModalRecuperacion(): void {
    this.modalRecuperacionActivo = false;
  }

  // M√©todos de utilidad para el template
  obtenerColorProgreso(progreso: number): string {
    if (progreso >= 100) return '#4caf50';
    if (progreso >= 75) return '#8bc34a';
    if (progreso >= 50) return '#ff9800';
    if (progreso >= 25) return '#2196f3';
    return '#9e9e9e';
  }

  obtenerDiasRestantes(objetivo: Objetivo): number {
    return Math.max(0, objetivo.dias - this.estadisticas.rachaActual);
  }

  formatearFecha(fecha: Date | null): string {
    if (!fecha) return 'Nunca';

    return fecha.toLocaleDateString('es-ES', {
      day: 'numeric',
      month: 'long',
      year: 'numeric',
    });
  }

  getTiempoSinActividad(): string {
    if (!this.estadisticas.fechaUltimaActividad) return 'Sin actividad previa';

    const ahora = new Date();
    const diferencia = ahora.getTime() - this.estadisticas.fechaUltimaActividad.getTime();
    const horas = Math.floor(diferencia / (1000 * 60 * 60));
    const dias = Math.floor(horas / 24);

    if (dias > 0) return `Hace ${dias} d√≠a${dias !== 1 ? 's' : ''}`;
    if (horas > 0) return `Hace ${horas} hora${horas !== 1 ? 's' : ''}`;
    return 'Hoy';
  }

  calcularRecuperacion(): number {
    return Math.max(1, Math.floor(this.estadisticas.rachaMaxima / 2));
  }

  volverAlDashboard(): void {
    this.router.navigate(['/usuario/dashboard-usuario']);
  }

  // M√©todo para debugging
  debugRachas(): void {
    console.log('Estado actual del sistema de rachas:', {
      estadisticas: this.estadisticas,
      objetivos: this.objetivos.map((o) => ({
        titulo: o.titulo,
        completado: o.completado,
        progreso: o.progreso,
      })),
      estados: {
        rachaEnPeligro: this.rachaEnPeligro,
        puedeUsarProteccion: this.puedeUsarProteccion,
        puedeUsarRecuperacion: this.puedeUsarRecuperacion,
      },
    });
  }
}
